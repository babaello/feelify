<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feelify - Your Mood Music Companion</title>
  <style>
    /* --- Reset and base styles --- */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a {
      color: #1DB954;
      text-decoration: none;
    }
    a:hover, a:focus {
      text-decoration: underline;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      transition: background-color 0.3s ease;
      user-select: none;
      outline-offset: 2px;
      outline-color: transparent;
    }
    button:focus-visible {
      outline-color: #1DB954;
    }
    input[type="text"] {
      border-radius: 5px;
      border: 1px solid #444;
      padding: 10px 14px;
      font-size: 1rem;
      background: #222;
      color: #eee;
      width: 100%;
      max-width: 300px;
      transition: border-color 0.3s ease;
    }
    input[type="text"]:focus {
      border-color: #1DB954;
      outline: none;
    }
    header {
      background: #181818;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.7);
    }
    header h1 {
      font-weight: 900;
      font-size: 1.8rem;
      letter-spacing: 0.1em;
      margin: 0;
      color: #1DB954;
      user-select: none;
    }
    #auth, #app {
      padding: 2rem;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    #auth {
      align-items: center;
      justify-content: center;
    }
    #login-btn, #logout-btn {
      background-color: #1DB954;
      color: #121212;
      padding: 12px 28px;
      font-size: 1.1rem;
      box-shadow: 0 6px #13a84d;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    #login-btn:hover, #logout-btn:hover {
      background-color: #17c05c;
    }
    #login-btn:active, #logout-btn:active {
      box-shadow: 0 2px #0d7733;
      transform: translateY(4px);
    }
    #logout-btn {
      background-color: #e5534b;
      color: white;
      box-shadow: 0 6px #b03f3b;
    }
    #logout-btn:hover {
      background-color: #f15b51;
    }
    #logout-btn:active {
      box-shadow: 0 2px #7c2d2b;
      transform: translateY(4px);
    }

    /* Search area */
    #search-area {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 1rem;
      align-items: center;
    }
    #mood-input {
      flex-grow: 1;
      min-width: 220px;
    }
    #search-btn, #random-btn {
      background-color: #1DB954;
      color: #121212;
      padding: 10px 20px;
      font-weight: 700;
      box-shadow: 0 5px #13a84d;
      user-select: none;
    }
    #search-btn:hover, #random-btn:hover {
      background-color: #17c05c;
    }
    #search-btn:active, #random-btn:active {
      box-shadow: 0 2px #0d7733;
      transform: translateY(3px);
    }

    /* Recent moods */
    #recent-moods {
      margin-bottom: 1.5rem;
    }
    #recent-moods h2 {
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 1.3rem;
      user-select: none;
      color: #1DB954;
    }
    #recent-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .mood-chip {
      background-color: #2e2e2e;
      padding: 8px 14px;
      border-radius: 50px;
      color: #ccc;
      font-weight: 600;
      transition: background-color 0.25s ease;
      user-select: none;
      cursor: pointer;
      border: 1.5px solid transparent;
    }
    .mood-chip:hover {
      background-color: #1DB954;
      color: #121212;
      border-color: #1DB954;
    }
    .mood-chip:focus-visible {
      outline: 2px solid #1DB954;
      outline-offset: 2px;
    }

    /* Tracks list */
    #tracks {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 55vh;
      overflow-y: auto;
      padding-right: 5px;
    }
    .track {
      display: flex;
      background-color: #222;
      border-radius: 10px;
      padding: 10px 15px;
      align-items: center;
      box-shadow: 0 3px 8px rgb(0 0 0 / 0.7);
      transition: background-color 0.3s ease;
    }
    .track:hover {
      background-color: #1DB954;
      color: #121212;
    }
    .track img {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      flex-shrink: 0;
      margin-right: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.6);
      user-select: none;
    }
    .track-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .track-info a.title-link {
      font-weight: 700;
      font-size: 1.1rem;
      color: inherit;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 350px;
    }
    .track-info a.artist-link {
      font-weight: 500;
      font-size: 0.9rem;
      color: #aaa;
    }
    .track-info a.artist-link:hover {
      color: #1DB954;
    }
    .track-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      user-select: none;
    }
    audio {
      outline: none;
      width: 160px;
      border-radius: 5px;
      cursor: pointer;
      filter: drop-shadow(0 0 2px #1DB954);
      user-select: none;
    }
    /* Error and Loading */
    #error-message {
      color: #ff4d4d;
      margin-top: 1rem;
      font-weight: 600;
      user-select: none;
    }
    #loading-indicator {
      color: #1DB954;
      margin-top: 1rem;
      font-weight: 600;
      user-select: none;
    }

    /* Toast notifications */
    #toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #1DB954dd;
      color: #121212;
      padding: 14px 22px;
      border-radius: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
      font-weight: 700;
      opacity: 0;
      pointer-events: none;
      user-select: none;
      transition: opacity 0.5s ease;
      z-index: 1100;
    }
    #toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Dark/Light toggle */
    #theme-toggle {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: #1DB954;
      cursor: pointer;
      user-select: none;
      transition: color 0.3s ease;
    }
    #theme-toggle:hover, #theme-toggle:focus-visible {
      color: #17c05c;
      outline: none;
    }

    /* Responsive */
    @media (max-width: 600px) {
      header {
        padding: 1rem;
      }
      #tracks {
        max-height: 40vh;
      }
      .track-info a.title-link {
        max-width: 180px;
      }
      audio {
        width: 120px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 tabindex="0" aria-label="Feelify: Your Mood Music Companion">FEELIFY</h1>
    <button id="theme-toggle" aria-label="Toggle dark and light mode" title="Toggle dark/light mode">ðŸŒ“</button>
  </header>

  <main>
    <!-- Auth container -->
    <section id="auth" aria-live="polite" aria-atomic="true">
      <button id="login-btn" aria-label="Login with Spotify">Log in with Spotify</button>
    </section>

    <!-- Main app container, hidden by default -->
    <section id="app" aria-live="polite" aria-atomic="true" style="display:none;">
      <div style="display:flex; justify-content: flex-end; margin-bottom: 1rem;">
        <button id="logout-btn" aria-label="Log out from Spotify">Log Out</button>
      </div>

      <div id="search-area" role="search" aria-label="Mood search">
        <input id="mood-input" type="text" aria-autocomplete="list" aria-haspopup="listbox" aria-expanded="false" aria-controls="mood-suggestions" placeholder="Enter your mood (e.g., happy)" autocomplete="off" />
        <button id="search-btn" aria-label="Search songs for mood">Search</button>
        <button id="random-btn" aria-label="Play random mood">Random Mood</button>
      </div>
      <ul id="mood-suggestions" role="listbox" aria-label="Mood suggestions" style="display:none; max-width: 300px; margin: 0; padding: 0; list-style:none;"></ul>

      <section id="recent-moods" aria-label="Recent moods searched">
        <h2>Recent Moods</h2>
        <div id="recent-buttons" role="list"></div>
      </section>

      <section id="tracks" aria-label="Search results - tracks" role="list"></section>

      <div id="loading-indicator" aria-live="assertive" aria-atomic="true" style="display:none;">Loading...</div>
      <div id="error-message" role="alert" aria-live="assertive" aria-atomic="true"></div>
    </section>
  </main>

  <div id="toast" role="alert" aria-live="assertive" aria-atomic="true" aria-relevant="additions"></div>

  <script>
    (function(){
      'use strict';

      const BACKEND_URL = 'https://feelify-backend.onrender.com';
      const MOOD_SUGGESTIONS = [
        "Happy", "Sad", "Relaxed", "Energetic", "Romantic", "Angry",
        "Nostalgic", "Sleepy", "Motivational", "Fun", "Calm", "Chill",
        "Excited", "Melancholy", "Peaceful", "Joyful", "Tender", "Powerful",
        "Playful", "Cheerful", "Dreamy", "Upbeat", "Love", "Heart",
        "Fury", "Memory", "Oldschool", "Quiet", "Dance", "Party"
      ];

      // Elements
      const authSection = document.getElementById('auth');
      const loginBtn = document.getElementById('login-btn');
      const appSection = document.getElementById('app');
      const logoutBtn = document.getElementById('logout-btn');
      const moodInput = document.getElementById('mood-input');
      const searchBtn = document.getElementById('search-btn');
      const randomBtn = document.getElementById('random-btn');
      const recentButtonsContainer = document.getElementById('recent-buttons');
      const tracksContainer = document.getElementById('tracks');
      const loadingIndicator = document.getElementById('loading-indicator');
      const errorMessage = document.getElementById('error-message');
      const toast = document.getElementById('toast');
      const moodSuggestions = document.getElementById('mood-suggestions');
      const themeToggleBtn = document.getElementById('theme-toggle');

      // State
      let accessToken = null;
      let recentMoods = [];
      let currentlyPlayingAudio = null;
      let moodAutocompleteOpen = false;
      let theme = localStorage.getItem('feelify-theme') || 'dark';

      // Initialize theme
      function applyTheme(t) {
        if(t === 'dark'){
          document.body.style.background = '#121212';
          document.body.style.color = '#eee';
        } else {
          document.body.style.background = '#f9f9f9';
          document.body.style.color = '#121212';
        }
      }
      applyTheme(theme);
      themeToggleBtn.textContent = theme === 'dark' ? 'ðŸŒ“' : 'ðŸŒž';

      themeToggleBtn.addEventListener('click', () => {
        theme = theme === 'dark' ? 'light' : 'dark';
        applyTheme(theme);
        localStorage.setItem('feelify-theme', theme);
        themeToggleBtn.textContent = theme === 'dark' ? 'ðŸŒ“' : 'ðŸŒž';
        showToast(`Switched to ${theme} mode`);
      });

      // Helpers
      function showToast(message, duration=3000){
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      }
      function setLoading(isLoading){
        loadingIndicator.style.display = isLoading ? 'block' : 'none';
        searchBtn.disabled = isLoading;
        randomBtn.disabled = isLoading;
        moodInput.disabled = isLoading;
      }
      function setError(msg){
        errorMessage.textContent = msg;
      }
      function clearError(){
        setError('');
      }

      // Fetch access token to check login status
      async function fetchAccessToken(){
        try {
          const res = await fetch(`${BACKEND_URL}/spotify-token`, {
            credentials: 'include'
          });
          if(res.status === 200){
            const data = await res.json();
            return data.accessToken || null;
          }
          return null;
        } catch(e) {
          return null;
        }
      }

      // Show or hide auth/app sections
      function showLoggedInUI(){
        authSection.style.display = 'none';
        appSection.style.display = 'flex';
      }
      function showLoggedOutUI(){
        authSection.style.display = 'flex';
        appSection.style.display = 'none';
      }

      // Load recent moods from backend
      async function loadRecentMoods(){
        try {
          const res = await fetch(`${BACKEND_URL}/recent-moods`, {credentials: 'include'});
          if(res.ok){
            const data = await res.json();
            recentMoods = data.recentMoods || [];
            renderRecentMoods();
            return true;
          }
          return false;
        } catch(e){
          return false;
        }
      }

      // Render recent moods chips/buttons
      function renderRecentMoods(){
        recentButtonsContainer.innerHTML = '';
        if(recentMoods.length === 0){
          recentButtonsContainer.textContent = 'No recent moods yet.';
          return;
        }
        recentMoods.forEach(mood => {
          const btn = document.createElement('button');
          btn.className = 'mood-chip';
          btn.textContent = capitalize(mood);
          btn.setAttribute('aria-label', `Search mood ${capitalize(mood)}`);
          btn.addEventListener('click', () => {
            moodInput.value = capitalize(mood);
            triggerSearch();
          });
          recentButtonsContainer.appendChild(btn);
       
        });
      }

      // Capitalize utility
      function capitalize(str) {
        if(!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
      }

      // Clear tracks container
      function clearTracks() {
        tracksContainer.innerHTML = '';
      }

      // Stop any playing audio
      function stopPlayingAudio() {
        if(currentlyPlayingAudio) {
          currentlyPlayingAudio.pause();
          currentlyPlayingAudio.currentTime = 0;
          currentlyPlayingAudio = null;
        }
      }

      // Render tracks list with play controls
      function renderTracks(tracks) {
        clearTracks();
        if(!tracks || tracks.length === 0){
          tracksContainer.textContent = 'No songs found for this mood.';
          return;
        }
        tracks.forEach(track => {
          const trackEl = document.createElement('li');
          trackEl.className = 'track';
          trackEl.setAttribute('role', 'listitem');

          // Album art
          const img = document.createElement('img');
          img.src = track.albumArtUrl || '';
          img.alt = `Album art for ${track.title} by ${track.artist}`;
          img.loading = 'lazy';

          // Info container
          const infoDiv = document.createElement('div');
          infoDiv.className = 'track-info';

          // Title with link
          const titleLink = document.createElement('a');
          titleLink.className = 'title-link';
          titleLink.href = track.trackUrl || '#';
          titleLink.target = '_blank';
          titleLink.rel = 'noopener noreferrer';
          titleLink.textContent = track.title;

          // Artist with link
          const artistLink = document.createElement('a');
          artistLink.className = 'artist-link';
          artistLink.href = track.artistUrl || '#';
          artistLink.target = '_blank';
          artistLink.rel = 'noopener noreferrer';
          artistLink.textContent = track.artist;

          infoDiv.appendChild(titleLink);
          infoDiv.appendChild(artistLink);

          // Audio preview controls
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'track-actions';

          if(track.previewUrl) {
            const audio = document.createElement('audio');
            audio.src = track.previewUrl;
            audio.controls = true;
            audio.preload = 'none';
            audio.setAttribute('aria-label', `Audio preview for ${track.title} by ${track.artist}`);

            // When audio starts playing, stop any other audio playing
            audio.addEventListener('play', () => {
              if(currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
                currentlyPlayingAudio.pause();
              }
              currentlyPlayingAudio = audio;
            });
            actionsDiv.appendChild(audio);
          } else {
            const noPreview = document.createElement('span');
            noPreview.textContent = 'No preview available';
            noPreview.style.color = '#888';
            actionsDiv.appendChild(noPreview);
          }

          trackEl.appendChild(img);
          trackEl.appendChild(infoDiv);
          trackEl.appendChild(actionsDiv);

          tracksContainer.appendChild(trackEl);
        });
      }

      // Fetch tracks by mood keyword from backend
      async function fetchTracksForMood(mood) {
        setLoading(true);
        clearError();
        clearTracks();

        try {
          const response = await fetch(`${BACKEND_URL}/search?mood=${encodeURIComponent(mood)}`, {
            credentials: 'include'
          });
          if(!response.ok){
            throw new Error(`Error: ${response.status} ${response.statusText}`);
          }
          const data = await response.json();

          if(!data.tracks || data.tracks.length === 0) {
            setError('No songs found for this mood.');
            clearTracks();
          } else {
            renderTracks(data.tracks);
            addToRecentMoods(mood);
          }
        } catch(err) {
          setError('Error fetching songs. Please try again.');
          clearTracks();
          console.error(err);
        } finally {
          setLoading(false);
        }
      }

      // Add mood to recent moods and persist via backend
      async function addToRecentMoods(mood) {
        mood = mood.toLowerCase();
        if(recentMoods.includes(mood)) return;
        recentMoods.unshift(mood);
        if(recentMoods.length > 10) recentMoods.pop();
        renderRecentMoods();

        // Send to backend to save
        try {
          await fetch(`${BACKEND_URL}/recent-moods`, {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mood })
          });
        } catch(e){
          console.warn('Failed to save recent mood', e);
        }
      }

      // Trigger a search from input value
      function triggerSearch() {
        const mood = moodInput.value.trim();
        if(!mood) {
          setError('Please enter a mood to search.');
          return;
        }
        clearError();
        stopPlayingAudio();
        fetchTracksForMood(mood);
      }

      // Trigger random mood search
      function triggerRandomMood() {
        const randomMood = MOOD_SUGGESTIONS[Math.floor(Math.random() * MOOD_SUGGESTIONS.length)];
        moodInput.value = randomMood;
        clearError();
        stopPlayingAudio();
        fetchTracksForMood(randomMood);
      }

      // Handle login button click
      loginBtn.addEventListener('click', () => {
        window.location.href = `${BACKEND_URL}/login`;
      });

      // Handle logout button click
      logoutBtn.addEventListener('click', async () => {
        try {
          await fetch(`${BACKEND_URL}/logout`, {
            method: 'POST',
            credentials: 'include'
          });
        } catch(e){}
        accessToken = null;
        showLoggedOutUI();
        clearTracks();
        recentButtonsContainer.innerHTML = '';
        showToast('Logged out');
      });

      // Search button click
      searchBtn.addEventListener('click', () => {
        triggerSearch();
      });

      // Random mood button click
      randomBtn.addEventListener('click', () => {
        triggerRandomMood();
      });

      // Enter key triggers search
      moodInput.addEventListener('keydown', e => {
        if(e.key === 'Enter') {
          e.preventDefault();
          triggerSearch();
          moodSuggestions.style.display = 'none';
          moodInput.setAttribute('aria-expanded', 'false');
        }
      });

      // Moods autocomplete UI
      function updateMoodSuggestions() {
        const val = moodInput.value.trim().toLowerCase();
        if(val.length === 0){
          moodSuggestions.style.display = 'none';
          moodInput.setAttribute('aria-expanded', 'false');
          return;
        }
        const filtered = MOOD_SUGGESTIONS.filter(m =>
          m.toLowerCase().startsWith(val)
        );
        if(filtered.length === 0){
          moodSuggestions.style.display = 'none';
          moodInput.setAttribute('aria-expanded', 'false');
          return;
        }
        moodSuggestions.innerHTML = '';
        filtered.forEach((mood, i) => {
          const li = document.createElement('li');
          li.textContent = mood;
          li.role = 'option';
          li.tabIndex = 0;
          li.addEventListener('click', () => {
            moodInput.value = mood;
            moodSuggestions.style.display = 'none';
            moodInput.setAttribute('aria-expanded', 'false');
            moodInput.focus();
          });
          li.addEventListener('keydown', e => {
            if(e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              moodInput.value = mood;
              moodSuggestions.style.display = 'none';
              moodInput.setAttribute('aria-expanded', 'false');
              moodInput.focus();
            }
          });
          moodSuggestions.appendChild(li);
        });
        moodSuggestions.style.display = 'block';
        moodInput.setAttribute('aria-expanded', 'true');
      }

      moodInput.addEventListener('input', () => {
        updateMoodSuggestions();
      });

      // Clicking outside closes autocomplete list
      document.addEventListener('click', e => {
        if(!moodSuggestions.contains(e.target) && e.target !== moodInput){
          moodSuggestions.style.display = 'none';
          moodInput.setAttribute('aria-expanded', 'false');
        }
      });

      // Keyboard nav in mood suggestions
      moodInput.addEventListener('keydown', e => {
        if(moodSuggestions.style.display !== 'block') return;

        const options = Array.from(moodSuggestions.children);
        if(options.length === 0) return;

        let index = options.findIndex(opt => opt === document.activeElement);

        if(e.key === 'ArrowDown'){
          e.preventDefault();
          if(index < options.length -1) options[index + 1].focus();
          else options[0].focus();
        } else if(e.key === 'ArrowUp'){
          e.preventDefault();
          if(index > 0) options[index -1].focus();
          else options[options.length-1].focus();
        }
      });

      // On page load - check login and load recent moods
      async function initialize() {
        accessToken = await fetchAccessToken();
        if(accessToken){
          showLoggedInUI();
          await loadRecentMoods();
        } else {
          showLoggedOutUI();
        }
      }

      // Initialize app
      initialize();

    })();
  </script>
</body>
</html>
