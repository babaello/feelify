<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Feelify – Find songs by your mood</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1db954, #191414);
    color: #fff;
    max-width: 700px;
    margin: 2rem auto;
    padding: 1rem 2rem;
    border-radius: 10px;
    box-shadow: 0 0 15px #1db954aa;
  }
  h1 {
    text-align: center;
    font-weight: 900;
    margin-bottom: 0.2em;
  }
  #loginBtn {
    background: #1db954;
    border: none;
    padding: 1em;
    width: 100%;
    font-weight: 700;
    font-size: 1.2em;
    border-radius: 25px;
    cursor: pointer;
    margin-bottom: 1.5rem;
    color: #121212;
    transition: background 0.3s ease;
  }
  #loginBtn:hover {
    background: #17a348;
  }
  #app {
    display: none;
  }
  input, button {
    font-size: 1em;
    padding: 0.75rem;
    border-radius: 25px;
    border: none;
    margin-bottom: 1rem;
    width: 100%;
    box-sizing: border-box;
  }
  input {
    padding-left: 1rem;
  }
  button {
    background: #1db954;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #17a348;
  }
  #results a {
    color: #1db954;
    display: block;
    margin: 0.25rem 0;
    text-decoration: none;
  }
  #results a:hover {
    text-decoration: underline;
  }
  .track {
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: #222;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .track img {
    width: 64px;
    height: 64px;
    border-radius: 6px;
  }
  .track-info {
    flex: 1;
  }
  .track-title {
    font-weight: 700;
  }
  .track-artists {
    font-size: 0.9em;
    color: #aaa;
  }
  .play-btn, .add-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: #1db954;
    font-size: 1.2em;
    margin-left: 0.5rem;
  }
  #userProfile {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #191414cc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  #userProfile img {
    border-radius: 50%;
    width: 64px;
  }
</style>
</head>
<body>

<h1>Feelify</h1>
<button id="loginBtn">Log in with Spotify</button>

<div id="app">
  <div id="userProfile"></div>

  <input type="text" id="moodInput" placeholder="Enter your mood or vibe" />
  <button id="searchBtn">Find Songs</button>
  <div id="results"></div>

  <h2>Your Playlists</h2>
  <div id="playlists"></div>
</div>

<script>
  const clientId = 'acb4336604304c339c55eb6db62513ca';
  const redirectUri = 'https://babaello.github.io/feelify/';
  const backendUrl = 'https://feelify-backend.onrender.com';

  const loginBtn = document.getElementById('loginBtn');
  const appDiv = document.getElementById('app');
  const searchBtn = document.getElementById('searchBtn');
  const moodInput = document.getElementById('moodInput');
  const resultsDiv = document.getElementById('results');
  const userProfileDiv = document.getElementById('userProfile');
  const playlistsDiv = document.getElementById('playlists');

  let accessToken = null;
  let refreshToken = null;
  let tokenExpiresAt = null;

  // Helper: Save tokens in localStorage for session persistence
  function saveTokens(access, refresh, expiresIn) {
    accessToken = access;
    refreshToken = refresh;
    tokenExpiresAt = Date.now() + expiresIn * 1000;

    localStorage.setItem('access_token', access);
    localStorage.setItem('refresh_token', refresh);
    localStorage.setItem('token_expires_at', tokenExpiresAt);
  }

  // Helper: Load tokens from localStorage
  function loadTokens() {
    accessToken = localStorage.getItem('access_token');
    refreshToken = localStorage.getItem('refresh_token');
    tokenExpiresAt = localStorage.getItem('token_expires_at');
    if (tokenExpiresAt) tokenExpiresAt = parseInt(tokenExpiresAt, 10);
  }

  // Refresh token when expired
  async function refreshAccessToken() {
    if (!refreshToken) return false;

    try {
      const response = await fetch(`${backendUrl}/refresh_token`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh_token: refreshToken })
      });
      const data = await response.json();
      if (data.access_token) {
        saveTokens(data.access_token, refreshToken, data.expires_in || 3600);
        return true;
      }
    } catch {
      // silently fail
    }
    return false;
  }

  // Check if token expired and refresh if needed
  async function ensureValidToken() {
    if (!accessToken) return false;
    if (Date.now() > tokenExpiresAt - 60000) { // refresh 1 min before expiry
      return await refreshAccessToken();
    }
    return true;
  }

  // Get URL param "code" for OAuth redirect
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');

  loadTokens();

  if (code) {
    loginBtn.style.display = 'none';
    resultsDiv.textContent = 'Logging in...';
    // Exchange code for tokens
    fetch(`${backendUrl}/exchange_token?code=${code}`)
      .then(res => res.json())
      .then(data => {
        if (data.access_token && data.refresh_token) {
          saveTokens(data.access_token, data.refresh_token, data.expires_in || 3600);
          history.replaceState(null, '', redirectUri);
          initApp();
        } else {
          resultsDiv.textContent = 'Login failed. Please try again.';
          loginBtn.style.display = 'block';
        }
      })
      .catch(() => {
        resultsDiv.textContent = 'Backend error during login.';
        loginBtn.style.display = 'block';
      });
  } else if (accessToken && refreshToken) {
    loginBtn.style.display = 'none';
    initApp();
  }

  loginBtn.onclick = () => {
    const scopes = [
      'user-read-private',
      'user-read-email',
      'playlist-read-private',
      'playlist-modify-private',
      'playlist-modify-public',
      'streaming',
      'user-modify-playback-state',
      'user-read-playback-state'
    ].join(' ');
    const authUrl =
      `https://accounts.spotify.com/authorize` +
      `?client_id=${clientId}` +
      `&response_type=code` +
      `&redirect_uri=${encodeURIComponent(redirectUri)}` +
      `&scope=${encodeURIComponent(scopes)}` +
      `&show_dialog=true`;
    window.location.href = authUrl;
  };

  async function initApp() {
    appDiv.style.display = 'block';
    resultsDiv.textContent = 'Logged in! Enter your mood to find songs.';

    await displayUserProfile();
    await displayUserPlaylists();
  }

  async function displayUserProfile() {
    if (!(await ensureValidToken())) {
      resultsDiv.textContent = 'Session expired. Please log in again.';
      loginBtn.style.display = 'block';
      appDiv.style.display = 'none';
      return;
    }
    try {
      const res = await fetch(`${backendUrl}/me?access_token=${accessToken}`);
      const profile = await res.json();
      userProfileDiv.innerHTML = `
        <img src="${profile.images?.[0]?.url || ''}" alt="User Avatar" />
        <div>
          <div><strong>${profile.display_name}</strong></div>
          <div>${profile.email}</div>
        </div>
      `;
    } catch {
      userProfileDiv.textContent = 'Failed to load profile.';
    }
  }

  async function displayUserPlaylists() {
    if (!(await ensureValidToken())) return;

    try {
      const res = await fetch(`${backendUrl}/playlists?access_token=${accessToken}`);
      const data = await res.json();
      playlistsDiv.innerHTML = '';
      if (data.items?.length) {
        data.items.forEach(pl => {
          const div = document.createElement('div');
          div.className = 'track';
          div.innerHTML = `
            <div class="track-info">
              <div class="track-title">${pl.name}</div>
              <div class="track-artists">Tracks: ${pl.tracks.total}</div>
            </div>
          `;
          playlistsDiv.appendChild(div);
        });
      } else {
        playlistsDiv.textContent = 'No playlists found.';
      }
    } catch {
      playlistsDiv.textContent = 'Failed to load playlists.';
    }
  }

  searchBtn.onclick = async () => {
    if (!(await ensureValidToken())) {
      alert('Session expired. Please log in again.');
      return;
    }
    const mood = moodInput.value.trim();
    if (!mood) return alert('Please enter a mood or vibe.');

    resultsDiv.textContent = 'Searching...';
    try {
      const res = await fetch(`${backendUrl}/search?q=${encodeURIComponent(mood)}&type=track&access_token=${accessToken}`);
      const data = await res.json();

      resultsDiv.innerHTML = '';
      if (!data.tracks?.items?.length) {
        resultsDiv.textContent = 'No songs found for that mood.';
        return;
      }

      data.tracks.items.forEach(track => {
        const div = document.createElement('div');
        div.className = 'track';

        const imgSrc = track.album.images?.[2]?.url || '';
        const artists = track.artists.map(a => a.name).join(', ');

        div.innerHTML = `
          <img src="${imgSrc}" alt="Album art" />
          <div class="track-info">
            <div class="track-title">${track.name}</div>
            <div class="track-artists">${artists}</div>
          </div>
          <button class="play-btn" title="Play preview">▶️</button>
          <button class="add-btn" title="Add to playlist">＋</button>
        `;

        // Play preview audio on clicking play button
        const playBtn = div.querySelector('.play-btn');
        let audio = null;
        playBtn.onclick = () => {
          if (audio && !audio.paused) {
            audio.pause();
            playBtn.textContent = '▶️';
          } else {
            if (audio) audio.pause();
            audio = new Audio(track.preview_url);
            audio.play();
            playBtn.textContent = '⏸️';

            audio.onended = () => {
              playBtn.textContent = '▶️';
            };
          }
        };

        // Add to playlist button (placeholder)
        const addBtn = div.querySelector('.add-btn');
        addBtn.onclick = () => {
          alert('Add to playlist feature coming soon!');
          // You can implement this by:
          // 1. Let user select a playlist
          // 2. Call Spotify API to add the track to that playlist
          //    (POST https://api.spotify.com/v1/playlists/{playlist_id}/tracks)
        };

        resultsDiv.appendChild(div);
      });
    } catch {
      resultsDiv.textContent = 'Error fetching songs.';
    }
  };
</script>

</body>
</html>
