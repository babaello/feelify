<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feelify - Your Mood, Your Music</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap');

    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #121212 0%, #1db954 100%);
      min-height: 100vh;
      color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    .container {
      background: rgba(18, 18, 18, 0.6);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow:
        0 4px 30px rgba(29, 185, 84, 0.4),
        inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      width: 100%;
      max-width: 720px;
      padding: 2rem 2.5rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.8rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    h1 {
      font-weight: 600;
      font-size: 2.8rem;
      color: #1db954;
      text-align: center;
      margin: 0 0 0.2rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      user-select: none;
    }
    h2 {
      margin: 1.5rem 0 0.7rem;
      color: #a1a1a1;
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: 0.06em;
    }
    #loginBtn {
      background: linear-gradient(135deg, #1db954, #16a247);
      border: none;
      border-radius: 40px;
      color: #121212;
      font-weight: 700;
      font-size: 1.3rem;
      padding: 1rem 0;
      cursor: pointer;
      box-shadow:
        0 6px 12px rgba(29, 185, 84, 0.7);
      transition: all 0.3s ease;
      user-select: none;
      width: 100%;
    }
    #loginBtn:hover {
      background: linear-gradient(135deg, #16a247, #1db954);
      box-shadow:
        0 8px 20px rgba(22, 162, 71, 0.9);
      transform: translateY(-3px);
    }
    #loginBtn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(22, 162, 71, 0.7);
    }
    #app {
      display: none;
    }
    #userProfile {
      display: flex;
      align-items: center;
      gap: 1.3rem;
      padding: 1rem 1.5rem;
      background: rgba(29, 185, 84, 0.15);
      border-radius: 16px;
      box-shadow: 0 0 15px rgba(29, 185, 84, 0.3);
      user-select: none;
    }
    #userProfile img {
      border-radius: 50%;
      width: 68px;
      height: 68px;
      object-fit: cover;
      border: 2.5px solid #1db954;
      box-shadow: 0 0 10px #1db954aa;
      flex-shrink: 0;
    }
    #userProfile div {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      color: #d4d4d4;
    }
    #userProfile div strong {
      font-size: 1.15rem;
      color: #fff;
    }
    #userProfile div small {
      font-size: 0.85rem;
      color: #a0a0a0;
    }
    #moodInput {
      width: 100%;
      border-radius: 30px;
      border: none;
      padding: 1rem 1.3rem;
      font-size: 1.1rem;
      font-weight: 400;
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
      box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.07);
      outline-offset: 2px;
      transition: background 0.25s ease;
      user-select: text;
    }
    #moodInput::placeholder {
      color: #c1c1c1;
      font-style: italic;
    }
    #moodInput:focus {
      background: rgba(255, 255, 255, 0.18);
      outline: none;
      box-shadow: 0 0 10px #1db954cc;
    }
    #searchBtn {
      background: linear-gradient(135deg, #1db954, #16a247);
      border: none;
      border-radius: 40px;
      color: #121212;
      font-weight: 700;
      font-size: 1.25rem;
      padding: 1rem 0;
      cursor: pointer;
      box-shadow:
        0 6px 14px rgba(29, 185, 84, 0.7);
      transition: all 0.3s ease;
      user-select: none;
      margin-top: -0.7rem;
      width: 100%;
    }
    #searchBtn:hover {
      background: linear-gradient(135deg, #16a247, #1db954);
      box-shadow:
        0 8px 22px rgba(22, 162, 71, 0.9);
      transform: translateY(-3px);
    }
    #searchBtn:active {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(22, 162, 71, 0.7);
    }
    #results,
    #playlists {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-top: 0.5rem;
      max-height: 320px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #1db954 transparent;
    }
    #results::-webkit-scrollbar,
    #playlists::-webkit-scrollbar {
      width: 6px;
    }
    #results::-webkit-scrollbar-thumb,
    #playlists::-webkit-scrollbar-thumb {
      background-color: #1db954;
      border-radius: 20px;
    }
    .track {
      background: rgba(18, 18, 18, 0.7);
      backdrop-filter: blur(8px);
      border-radius: 14px;
      padding: 0.8rem 1rem;
      display: flex;
      align-items: center;
      gap: 1.15rem;
      box-shadow: 0 0 18px #1db954aa;
      transition: background 0.3s ease;
      user-select: none;
    }
    .track:hover {
      background: rgba(29, 185, 84, 0.15);
      box-shadow: 0 0 22px #1db954dd;
    }
    .track img {
      width: 68px;
      height: 68px;
      border-radius: 12px;
      box-shadow: 0 0 7px #1db954cc;
      flex-shrink: 0;
      object-fit: cover;
    }
    .track-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      overflow: hidden;
    }
    .track-title {
      font-weight: 600;
      font-size: 1.1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #e0e0e0;
    }
    .track-artists {
      font-size: 0.9rem;
      font-weight: 400;
      color: #a0a0a0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .play-btn,
    .add-btn {
      border: none;
      cursor: pointer;
      background: transparent;
      color: #1db954;
      font-size: 1.6rem;
      transition: color 0.3s ease;
      padding: 0.1rem 0.4rem;
      user-select: none;
      flex-shrink: 0;
    }
    .play-btn:hover,
    .add-btn:hover {
      color: #16a247;
    }
    section > h2 {
      margin-top: 1.5rem;
      color: #a1a1a1;
      font-weight: 600;
      font-size: 1.3rem;
      letter-spacing: 0.06em;
    }
    @media (max-width: 480px) {
      .container {
        padding: 1.5rem 1.8rem 2.2rem;
      }
      h1 {
        font-size: 2.2rem;
      }
      #userProfile img {
        width: 52px;
        height: 52px;
      }
      .track img {
        width: 52px;
        height: 52px;
      }
      .play-btn,
      .add-btn {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>

  <div class="container" role="main" aria-live="polite">
    <h1>Feelify</h1>
    <button id="loginBtn" aria-label="Log in with Spotify">Log in with Spotify</button>

    <div id="app" aria-live="polite" tabindex="-1">
      <div id="userProfile" aria-label="User profile info"></div>

      <input
        id="moodInput"
        type="text"
        placeholder="Enter your mood or vibe..."
        aria-label="Mood or vibe input"
        autocomplete="off"
        spellcheck="false"
      />
      <button id="searchBtn" aria-label="Search songs for mood">Find Songs</button>

      <section>
        <h2>Song Results</h2>
        <div id="results"></div>
      </section>

      <section>
        <h2>Your Playlists</h2>
        <div id="playlists"></div>
      </section>
    </div>
  </div>

  <script>
    // === CONFIGURATION ===
    const backendBaseUrl = 'https://your-backend-url.com'; // CHANGE to your backend URL
    const spotifyClientId = 'YOUR_SPOTIFY_CLIENT_ID'; // CHANGE to your Spotify client ID
    const redirectUri = window.location.origin + window.location.pathname; // Current page, no query params

    // === UTILS ===
    function generateRandomString(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    function parseQueryParams() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let params = {};
      for (const [key, value] of urlParams.entries()) {
        params[key] = value;
      }
      return params;
    }

    function clearQueryParams() {
      if (window.history && window.history.replaceState) {
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
      }
    }

    // === SPOTIFY AUTH ===
    const scopes = [
      'user-read-private',
      'user-read-email',
      'playlist-read-private',
      'playlist-modify-public',
      'playlist-modify-private',
      'user-library-modify',
      'user-read-playback-state',
      'user-modify-playback-state'
    ];

    let accessToken = null;
    let refreshToken = null;
    let tokenExpiryTime = null;

    const loginBtn = document.getElementById('loginBtn');
    const appDiv = document.getElementById('app');
    const userProfileDiv = document.getElementById('userProfile');
    const moodInput = document.getElementById('moodInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const playlistsDiv = document.getElementById('playlists');

    let audio = new Audio();
    let currentPlayingTrackId = null;

    // PKCE flow helpers
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return new Uint8Array(hash);
    }

    function base64UrlEncode(arrayBuffer) {
      return btoa(String.fromCharCode.apply(null, arrayBuffer))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function generateCodeChallenge(codeVerifier) {
      const hashed = await sha256(codeVerifier);
      return base64UrlEncode(hashed);
    }

    async function startLogin() {
      const state = generateRandomString(16);
      const codeVerifier = generateRandomString(64);
      sessionStorage.setItem('pkce_code_verifier', codeVerifier);
      sessionStorage.setItem('oauth_state', state);

      const codeChallenge = await generateCodeChallenge(codeVerifier);
      const scope = scopes.join(' ');

      const authUrl = `https://accounts.spotify.com/authorize?client_id=${encodeURIComponent(spotifyClientId)}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&state=${state}&code_challenge_method=S256&code_challenge=${codeChallenge}`;

      window.location = authUrl;
    }

    async function exchangeToken(code) {
      const codeVerifier = sessionStorage.getItem('pkce_code_verifier');
      try {
        const res = await fetch(`${backendBaseUrl}/exchange_token?code=${encodeURIComponent(code)}`, {
          method: 'GET',
        });
        if (!res.ok) throw new Error('Failed to exchange token');
        const data = await res.json();
        accessToken = data.access_token;
        refreshToken = data.refresh_token;
        tokenExpiryTime = Date.now() + (data.expires_in * 1000);
        sessionStorage.setItem('access_token', accessToken);
        sessionStorage.setItem('refresh_token', refreshToken);
        sessionStorage.setItem('token_expiry', tokenExpiryTime);
        sessionStorage.removeItem('pkce_code_verifier');
        sessionStorage.removeItem('oauth_state');
        clearQueryParams();
        return true;
      } catch (err) {
        alert('Error during token exchange: ' + err.message);
        return false;
      }
    }

    async function refreshAccessToken() {
      if (!refreshToken) return false;
      try {
        const res = await fetch(`${backendBaseUrl}/refresh_token?refresh_token=${refreshToken}`, { method: 'GET' });
        if (!res.ok) throw new Error('Failed to refresh token');
        const data = await res.json();
        accessToken = data.access_token;
        tokenExpiryTime = Date.now() + (data.expires_in * 1000);
        sessionStorage.setItem('access_token', accessToken);
        sessionStorage.setItem('token_expiry', tokenExpiryTime);
        return true;
      } catch {
        return false;
      }
    }

    async function ensureTokenValid() {
      if (!accessToken) return false;
      if (Date.now() > tokenExpiryTime - 60000) {
        // token expiring soon, refresh
        const refreshed = await refreshAccessToken();
        if (!refreshed) {
          logout();
          return false;
        }
      }
      return true;
    }

    // === UI Updates ===

    async function fetchUserProfile() {
      await ensureTokenValid();
      try {
        const res = await fetch('https://api.spotify.com/v1/me', {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        if (!res.ok) throw new Error('Failed to get user profile');
        const data = await res.json();
        renderUserProfile(data);
        await fetchUserPlaylists();
      } catch (err) {
        alert(err.message);
      }
    }

    function renderUserProfile(user) {
      userProfileDiv.innerHTML = `
        <img src="${user.images[0]?.url || 'https://via.placeholder.com/68'}" alt="User avatar" />
        <div>
          <strong>${user.display_name}</strong>
          <small>${user.email}</small>
        </div>
      `;
    }

    async function fetchUserPlaylists() {
      await ensureTokenValid();
      try {
        const res = await fetch('https://api.spotify.com/v1/me/playlists?limit=10', {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        if (!res.ok) throw new Error('Failed to get playlists');
        const data = await res.json();
        renderPlaylists(data.items);
      } catch (err) {
        playlistsDiv.innerHTML = `<em>Could not load playlists</em>`;
      }
    }

    function renderPlaylists(playlists) {
      playlistsDiv.innerHTML = '';
      if (playlists.length === 0) {
        playlistsDiv.innerHTML = '<em>No playlists found</em>';
        return;
      }
      playlists.forEach(pl => {
        const plEl = document.createElement('div');
        plEl.className = 'track';
        plEl.innerHTML = `
          <img src="${pl.images[0]?.url || 'https://via.placeholder.com/68'}" alt="Playlist cover" />
          <div class="track-info" title="${pl.name}">
            <div class="track-title">${pl.name}</div>
            <div class="track-artists">${pl.tracks.total} tracks</div>
          </div>
        `;
        playlistsDiv.appendChild(plEl);
      });
    }

    // === Mood Search ===

    async function searchMoodTracks(mood) {
      mood = mood.trim();
      if (!mood) {
        alert('Please enter a mood or vibe');
        return;
      }
      resultsDiv.innerHTML = '<em>Loading tracks...</em>';
      try {
        // Your backend endpoint for mood search
        const res = await fetch(`${backendBaseUrl}/mood_search?mood=${encodeURIComponent(mood)}`, {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        if (!res.ok) throw new Error('Failed to search tracks for mood');
        const data = await res.json();
        renderTracks(data.tracks);
      } catch (err) {
        resultsDiv.innerHTML = `<em>Error: ${err.message}</em>`;
      }
    }

    function renderTracks(tracks) {
      resultsDiv.innerHTML = '';
      if (!tracks || tracks.length === 0) {
        resultsDiv.innerHTML = '<em>No tracks found for that mood.</em>';
        return;
      }
      tracks.forEach(track => {
        const trackEl = document.createElement('div');
        trackEl.className = 'track';
        trackEl.setAttribute('data-track-id', track.id);

        trackEl.innerHTML = `
          <img src="${track.album.images[0]?.url || 'https://via.placeholder.com/68'}" alt="Album art" />
          <div class="track-info" title="${track.name} by ${track.artists.map(a => a.name).join(', ')}">
            <div class="track-title">${track.name}</div>
            <div class="track-artists">${track.artists.map(a => a.name).join(', ')}</div>
          </div>
          <button class="play-btn" aria-label="Play preview">&#9658;</button>
          <button class="add-btn" aria-label="Add to playlist">+</button>
        `;

        const playBtn = trackEl.querySelector('.play-btn');
        const addBtn = trackEl.querySelector('.add-btn');

        playBtn.onclick = () => {
          if (currentPlayingTrackId === track.id) {
            audio.pause();
            currentPlayingTrackId = null;
            playBtn.innerHTML = '&#9658;';
          } else {
            playTrackPreview(track.preview_url, playBtn, track.id);
          }
        };

        addBtn.onclick = () => {
          promptAddToPlaylist(track.id, track.name);
        };

        resultsDiv.appendChild(trackEl);
      });
    }

    function playTrackPreview(previewUrl, btn, trackId) {
      if (!previewUrl) {
        alert('No preview available for this track.');
        return;
      }
      if (currentPlayingTrackId && currentPlayingTrackId !== trackId) {
        audio.pause();
        // Reset old play button icons
        [...document.querySelectorAll('.play-btn')].forEach(b => (b.innerHTML = '&#9658;'));
      }

      if (audio.paused || currentPlayingTrackId !== trackId) {
        audio.src = previewUrl;
        audio.play();
        btn.innerHTML = '&#10074;&#10074;';
        currentPlayingTrackId = trackId;
      } else {
        audio.pause();
        btn.innerHTML = '&#9658;';
        currentPlayingTrackId = null;
      }

      audio.onended = () => {
        btn.innerHTML = '&#9658;';
        currentPlayingTrackId = null;
      };
    }

    async function promptAddToPlaylist(trackId, trackName) {
      // Fetch playlists again to make sure fresh
      await ensureTokenValid();
      let playlistId = prompt('Enter Playlist ID to add "' + trackName + '" to:\n(To get playlist ID: open your playlist in Spotify and copy the last part of the URL after /playlist/ )');
      if (!playlistId) return;

      try {
        const res = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            uris: [`spotify:track:${trackId}`],
          }),
        });
        if (!res.ok) throw new Error('Failed to add track to playlist');
        alert(`Added "${trackName}" to playlist!`);
      } catch (err) {
        alert('Error adding to playlist: ' + err.message);
      }
    }

    // === Main flow ===

    loginBtn.onclick = () => startLogin();

    async function main() {
      // Check if redirected back from Spotify auth with code
      const params = parseQueryParams();

      if (params.error) {
        alert('Spotify authorization error: ' + params.error);
        clearQueryParams();
        return;
      }

      if (params.code) {
        // exchange token via backend
        const exchanged = await exchangeToken(params.code);
        if (exchanged) {
          loginBtn.style.display = 'none';
          appDiv.style.display = 'flex';
          await fetchUserProfile();
          moodInput.focus();
        }
        return;
      }

      // Check if tokens stored in sessionStorage
      accessToken = sessionStorage.getItem('access_token');
      refreshToken = sessionStorage.getItem('refresh_token');
      tokenExpiryTime = parseInt(sessionStorage.getItem('token_expiry'), 10);

      if (accessToken && tokenExpiryTime && Date.now() < tokenExpiryTime) {
        loginBtn.style.display = 'none';
        appDiv.style.display = 'flex';
        await fetchUserProfile();
        moodInput.focus();
      }
    }

    searchBtn.onclick = () => searchMoodTracks(moodInput.value);

    main();
  </script>

</body>
</html>
