<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feelify â€“ Find Songs by Your Mood</title>
  <style>
    /* Reset and base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 1rem;
      transition: background 0.5s ease, color 0.5s ease;
    }

    /* Theme variables */
    :root {
      --green: #1DB954;
      --green-dark: #17a247;
      --bg-dark-start: #121212;
      --bg-dark-end: #1db954;
      --bg-light-start: #f0f4f8;
      --bg-light-end: #88c057;
      --text-color-dark: #fff;
      --text-color-light: #121212;
      --bg-gradient: linear-gradient(135deg, var(--bg-dark-start), var(--bg-dark-end));
      --text-color: var(--text-color-dark);
      --input-bg: #222;
      --input-border: var(--green);
      --btn-bg: var(--green);
      --btn-color: var(--bg-dark-start);
      --shadow-color: rgba(29, 185, 84, 0.3);
    }
    body.light {
      --bg-gradient: linear-gradient(135deg, var(--bg-light-start), var(--bg-light-end));
      --text-color: var(--text-color-light);
      --input-bg: #fff;
      --input-border: var(--green-dark);
      --btn-bg: var(--green-dark);
      --btn-color: #fff;
      --shadow-color: rgba(23, 162, 71, 0.4);
    }

    /* Container */
    main {
      background: var(--bg-gradient);
      max-width: 600px;
      width: 100%;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 0 20px var(--shadow-color);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      font-weight: 900;
      font-size: 2.8rem;
      margin: 0;
      letter-spacing: 3px;
      text-shadow: 0 0 10px var(--green);
      color: var(--text-color);
      user-select: none;
    }

    /* Toggle Button */
    #themeToggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: none;
      border: 2px solid var(--btn-bg);
      color: var(--btn-bg);
      border-radius: 20px;
      padding: 0.3rem 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      user-select: none;
    }
    #themeToggle:hover {
      background-color: var(--btn-bg);
      color: var(--btn-color);
    }

    /* Inputs and buttons */
    input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1.1rem;
      border-radius: 8px;
      border: 2px solid var(--input-border);
      background-color: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.3s ease;
      outline-offset: 2px;
      outline-color: var(--green);
    }
    input[type="text"]:focus {
      border-color: var(--btn-bg);
      outline-color: var(--btn-bg);
    }

    button {
      font-size: 1.1rem;
      padding: 0.85rem 0;
      border-radius: 8px;
      border: none;
      background-color: var(--btn-bg);
      color: var(--btn-color);
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 5px 10px var(--shadow-color);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:hover:not(:disabled) {
      background-color: var(--green-dark);
      box-shadow: 0 7px 14px var(--shadow-color);
    }
    button:focus-visible {
      outline: 3px solid var(--btn-color);
      outline-offset: 3px;
    }

    /* Login Button */
    #loginBtn {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      display: block;
    }

    /* App container */
    #app {
      display: none;
      flex-direction: column;
      gap: 1rem;
    }

    /* Results container */
    #results {
      margin-top: 1rem;
      max-height: 350px;
      overflow-y: auto;
      padding-right: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: var(--green) transparent;
      border-radius: 8px;
      background: var(--input-bg);
      box-shadow: inset 0 0 5px #0004;
    }
    #results::-webkit-scrollbar {
      width: 8px;
    }
    #results::-webkit-scrollbar-track {
      background: transparent;
    }
    #results::-webkit-scrollbar-thumb {
      background-color: var(--green);
      border-radius: 8px;
    }

    /* Each track */
    .track {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #444;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: background-color 0.2s ease;
      cursor: pointer;
      border-radius: 6px;
    }
    .track:last-child {
      border-bottom: none;
    }
    .track:hover, .track:focus {
      background-color: var(--green-dark);
      outline: none;
    }

    .track img {
      width: 64px;
      height: 64px;
      border-radius: 6px;
      flex-shrink: 0;
      user-select: none;
      box-shadow: 0 2px 6px #0009;
    }

    .track-info {
      flex-grow: 1;
      color: var(--text-color);
      user-select: none;
    }
    .track-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin: 0;
      user-select: text;
    }
    .artist-name {
      font-size: 0.9rem;
      color: #a0d3a0;
      margin: 0.2rem 0 0;
      user-select: text;
    }

    /* Audio preview */
    .audio-preview {
      margin-left: auto;
      flex-shrink: 0;
    }
    audio {
      outline: none;
      border-radius: 6px;
      box-shadow: 0 0 5px var(--green);
    }

    /* Add to playlist button */
    .add-btn {
      margin-left: 1rem;
      background-color: transparent;
      color: var(--green);
      border: 2px solid var(--green);
      padding: 0.3rem 0.6rem;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    .add-btn:hover {
      background-color: var(--green);
      color: var(--btn-color);
    }
    .add-btn:focus-visible {
      outline: 3px solid var(--btn-color);
      outline-offset: 3px;
    }

    /* Info / error messages */
    #message {
      text-align: center;
      font-weight: 600;
      min-height: 1.5rem;
      user-select: none;
      font-size: 1.1rem;
    }
    #message.error {
      color: #f44336;
    }
    #message.info {
      color: var(--green);
    }

    /* Loading spinner */
    .spinner {
      margin: 2rem auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--green);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      user-select: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Responsive */
    @media (max-width: 480px) {
      main {
        padding: 1.5rem 1rem;
      }
      .track img {
        width: 48px;
        height: 48px;
      }
      .track-name {
        font-size: 1rem;
      }
      .artist-name {
        font-size: 0.8rem;
      }
      button, input[type="text"] {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

  <button id="themeToggle" aria-label="Toggle light/dark mode">Toggle Light/Dark Mode</button>

  <main role="main" aria-label="Feelify music mood finder app">
    <h1>Feelify</h1>

    <button id="loginBtn" aria-label="Log in with Spotify">Log in with Spotify</button>

    <section id="app" aria-live="polite" aria-atomic="true">
      <input
        type="text"
        id="moodInput"
        placeholder="Enter your mood or vibe (e.g. happy, sad, chill)"
        aria-label="Mood input"
        autocomplete="off"
      />
      <button id="searchBtn" aria-label="Find songs by mood">Find Songs</button>

      <div id="message" role="alert" aria-live="assertive"></div>

      <div id="results" tabindex="0" aria-label="Song results list"></div>

      <button id="createPlaylistBtn" disabled aria-label="Create playlist with these songs">Create Playlist with Songs</button>
    </section>
  </main>

  <script>
    // Configuration
    const clientId = 'acb4336604304c339c55eb6db62513ca'; // Your Spotify client ID
    const redirectUri = 'https://babaello.github.io/feelify/'; // Your redirect URI
    const backendUrl = 'https://feelify-backend.onrender.com'; // Your backend URL

    // Elements
    const loginBtn = document.getElementById('loginBtn');
    const appDiv = document.getElementById('app');
    const searchBtn = document.getElementById('searchBtn');
    const moodInput = document.getElementById('moodInput');
    const resultsDiv = document.getElementById('results');
    const messageDiv = document.getElementById('message');
    const createPlaylistBtn = document.getElementById('createPlaylistBtn');
    const themeToggle = document.getElementById('themeToggle');

    // Mood mapping to valence, energy, and genres
    const moodMap = {
      happy: { valence: 0.9, energy: 0.8, genres: ['pop'] },
      sad: { valence: 0.2, energy: 0.3, genres: ['acoustic', 'piano'] },
      chill: { valence: 0.6, energy: 0.4, genres: ['chill', 'ambient'] },
      energetic: { valence: 0.8, energy: 0.9, genres: ['dance', 'edm'] },
      romantic: { valence: 0.7, energy: 0.5, genres: ['rnb', 'soul'] },
      angry: { valence: 0.3, energy: 0.9, genres: ['metal', 'rock'] }
    };

    // State variables
    let accessToken = null;
    let recommendedTracks = [];

    // Utility: Get mood parameters, fallback to default
    function getMoodParams(mood) {
      mood = mood.toLowerCase();
      return moodMap[mood] || { valence: 0.5, energy: 0.5, genres: ['pop'] };
    }

    // Utility: Show messages
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.className = type;
    }

    // Utility: Show loading spinner
    function showLoading() {
      resultsDiv.innerHTML = '<div class="spinner" aria-label="Loading"></div>';
    }

    // Clear results
    function clearResults() {
      resultsDiv.innerHTML = '';
    }

    // Setup theme from localStorage or default
    function setupTheme() {
      const saved = localStorage.getItem('feelify-theme');
      if (saved === 'light') {
        document.body.classList.add('light');
        themeToggle.textContent = 'Switch to Dark Mode';
      } else {
        document.body.classList.remove('light');
        themeToggle.textContent = 'Switch to Light Mode';
      }
    }
    setupTheme();

    themeToggle.onclick = () => {
      document.body.classList.toggle('light');
      const isLight = document.body.classList.contains('light');
      localStorage.setItem('feelify-theme', isLight ? 'light' : 'dark');
      themeToggle.textContent = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
    };

    // Parse URL to get code
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    // Handle Spotify OAuth callback
    if (code) {
      loginBtn.style.display = 'none';
      showMessage('Logging in...');
      fetch(`${backendUrl}/exchange_token?code=${code}`)
        .then(res => res.json())
        .then(data => {
          if (data.access_token) {
            accessToken = data.access_token;
            showMessage('Logged in! Enter your mood to find songs.');
            appDiv.style.display = 'flex';
            createPlaylistBtn.disabled = true;
            history.replaceState(null, '', redirectUri);
          } else {
            showMessage('Error obtaining access token.', 'error');
          }
        })
        .catch(() => {
          showMessage('Failed to connect to backend.', 'error');
        });
    } else {
      showMessage('Please log in with Spotify to continue.');
    }

    // Login button action
    loginBtn.onclick = () => {
      const scopes = [
        'user-read-private',
        'user-read-email',
        'playlist-modify-public',
        'playlist-modify-private',
      ].join(' ');
      const authUrl =
        `https://accounts.spotify.com/authorize` +
        `?client_id=${clientId}` +
        `&response_type=code` +
        `&redirect_uri=${encodeURIComponent(redirectUri)}` +
        `&scope=${encodeURIComponent(scopes)}` +
        `&show_dialog=true`;
      window.location.href = authUrl;
    };

    // Create playlist button action
    createPlaylistBtn.onclick = async () => {
      if (!accessToken) return alert('Please log in first.');

      showMessage('Creating playlist...', 'info');
      createPlaylistBtn.disabled = true;

      try {
        // Get current user id
        const userRes = await fetch('https://api.spotify.com/v1/me', {
          headers: { Authorization: `Bearer ${accessToken}` },
        });
        const userData = await userRes.json();
        const userId = userData.id;

        // Create playlist
        const playlistName = `Feelify Mood Playlist - ${new Date().toLocaleDateString()}`;
        const createRes = await fetch(`https://api.spotify.com/v1/users/${userId}/playlists`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: playlistName,
            description: 'Playlist created with Feelify based on your mood',
            public: false,
          }),
        });
        const playlistData = await createRes.json();

        // Add tracks to playlist
        const uris = recommendedTracks.map(t => t.uri);
        const addRes = await fetch(`https://api.spotify.com/v1/playlists/${playlistData.id}/tracks`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${accessToken}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ uris }),
        });

        if (addRes.ok) {
          showMessage(`Playlist "${playlistName}" created! Check your Spotify account.`, 'info');
          createPlaylistBtn.disabled = true;
        } else {
          showMessage('Failed to add tracks to playlist.', 'error');
          createPlaylistBtn.disabled = false;
        }
      } catch (error) {
        showMessage('Error creating playlist. Try again.', 'error');
        createPlaylistBtn.disabled = false;
      }
    };

    // Search songs by mood
    async function searchSongs() {
      const mood = moodInput.value.trim();
      if (!accessToken) {
        alert('Please log in first.');
        return;
      }
      if (!mood) {
        alert('Please enter a mood or vibe.');
        return;
      }

      showLoading();
      showMessage('');

      const { valence, energy, genres } = getMoodParams(mood);
      const
