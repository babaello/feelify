<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mood Mosaic + Music Vibe (Spotify Edition)</title>
<style>
  /* Styles same as before + additions */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  header {
    margin: 2rem;
    text-align: center;
  }
  header h1 {
    font-weight: 900;
    font-size: 2.5rem;
    letter-spacing: 0.1em;
  }
  header p {
    font-size: 1.1rem;
    color: #bbb;
    margin-top: 0.3rem;
  }
  form {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
  }
  input[type="text"] {
    font-size: 1.1rem;
    padding: 0.5rem 1rem;
    width: 280px;
    border: none;
    border-radius: 5px 0 0 5px;
    outline: none;
  }
  button {
    font-size: 1.1rem;
    padding: 0.5rem 1.2rem;
    border: none;
    border-radius: 0 5px 5px 0;
    background: #4CAF50;
    color: white;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #388E3C;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  main {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
    gap: 1rem;
    width: 90vw;
    max-width: 1200px;
    margin-bottom: 3rem;
  }
  .mosaic {
    width: 180px;
    height: 180px;
    background: #222;
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    grid-template-rows: repeat(8, 1fr);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 0 8px #000a inset;
    cursor: pointer;
    transition: transform 0.2s ease;
    position: relative;
  }
  .mosaic:hover {
    transform: scale(1.1);
    box-shadow: 0 0 12px #4CAF50 inset;
  }
  .tile {
    width: 100%;
    height: 100%;
    filter: brightness(1);
    transition: filter 0.2s ease;
  }
  .mosaic:hover .tile {
    filter: brightness(1.2);
  }
  .music-recommendation {
    position: absolute;
    bottom: 6px;
    left: 6px;
    right: 6px;
    background: rgba(0,0,0,0.6);
    color: #ddd;
    font-size: 0.75rem;
    padding: 4px 6px;
    border-radius: 5px;
    pointer-events: none;
    user-select: none;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  #nowPlaying {
    margin-top: 1rem;
    text-align: center;
    max-width: 400px;
    background: #222;
    padding: 1rem;
    border-radius: 12px;
    box-shadow: 0 0 15px #4caf5080;
  }
  #nowPlaying h2 {
    margin-bottom: 0.5rem;
  }
  iframe {
    border-radius: 10px;
  }
  #loginPrompt {
    margin-bottom: 1rem;
    color: #f44336;
    font-weight: 600;
  }
  #saveShareBtn {
    margin-top: 1rem;
    background: #2196F3;
    border-radius: 5px;
  }
  #saveShareBtn:hover {
    background: #1976d2;
  }
  footer {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 1rem;
  }
  #shareLink {
    margin-top: 0.5rem;
    word-break: break-all;
    font-size: 0.9rem;
    color: #4caf50;
  }
</style>
</head>
<body>

<header>
  <h1>Mood Mosaic + Music Vibe (Spotify Edition)</h1>
  <p>Enter your mood or vibe, get unique mosaic art plus real music recommendations via Spotify.</p>
</header>

<div id="loginPrompt"></div>

<form id="moodForm">
  <input type="text" id="moodInput" placeholder="Type your mood or vibe..." autocomplete="off" required />
  <button type="submit" id="createBtn">Create</button>
</form>

<div id="nowPlaying"></div>
<button id="saveShareBtn" disabled>Save & Share This Combo</button>
<div id="shareLink"></div>

<main id="gallery"></main>

<footer>Â© 2025 Mood Mosaic - Art & Music from your emotions</footer>

<script>
  // -------- Spotify Auth Setup --------
  const clientId = '2f0b86bdae1c4886b70ab2574cff5fb0'; // Replace with your Spotify Client ID
  const redirectUri = window.location.origin + window.location.pathname; // redirect to this page
  const scopes = 'user-read-private user-read-email'; // minimal scopes needed
  const authEndpoint = 'https://accounts.spotify.com/authorize';

  // Extract token from URL hash after redirect
  function getTokenFromUrl() {
    return window.location.hash
      .substring(1)
      .split('&')
      .reduce((initial, item) => {
        if (item) {
          const parts = item.split('=');
          initial[parts[0]] = decodeURIComponent(parts[1]);
        }
        return initial;
      }, {});
  }

  // Check if token present and valid
  let spotifyToken = null;
  let tokenExpiresAt = 0;

  function isTokenValid() {
    return spotifyToken && Date.now() < tokenExpiresAt;
  }

  // Redirect user to Spotify login for token
  function redirectToSpotifyAuth() {
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${scopes}&state=${state}`;
  }

  // On page load, parse token
  window.onload = () => {
    const tokenInfo = getTokenFromUrl();
    if (tokenInfo.access_token) {
      spotifyToken = tokenInfo.access_token;
      tokenExpiresAt = Date.now() + tokenInfo.expires_in * 1000;
      window.history.pushState({}, null, redirectUri); // Remove token from URL
      document.getElementById('loginPrompt').textContent = 'Spotify logged in! You can now get music recommendations.';
      document.getElementById('createBtn').disabled = false;
    } else {
      document.getElementById('loginPrompt').innerHTML = 'You must <a href="#" id="loginLink">log in with Spotify</a> to get music recommendations.';
      document.getElementById('createBtn').disabled = true;
      document.getElementById('loginLink').addEventListener('click', (e) => {
        e.preventDefault();
        redirectToSpotifyAuth();
      });
    }

    // Check if page loaded with saved combo in URL
    checkUrlForSharedCombo();
  };

  // -------- Mood Sentiment & Colors --------
  const sentimentColors = {
    positive: ['#4CAF50', '#81C784', '#AED581', '#388E3C', '#C5E1A5'],
    neutral: ['#90A4AE', '#B0BEC5', '#78909C', '#CFD8DC', '#455A64'],
    negative: ['#E57373', '#EF5350', '#F44336', '#D32F2F', '#B71C1C']
  };

  const extendedSentiments = {
    happy: 'positive', joy: 'positive', love: 'positive', excited: 'positive', calm: 'positive',
    energetic: 'positive', chill: 'positive', relaxed: 'positive', peaceful: 'positive',
    sad: 'negative', angry: 'negative', fear: 'negative', tired: 'negative', lonely: 'negative',
    anxious: 'negative', bored: 'neutral', meh: 'neutral', okay: 'neutral', confused: 'neutral', neutral: 'neutral',
    romantic: 'positive', party: 'positive', mellow: 'neutral'
  };

  // Extended moods for Spotify searching
  const moodToSpotifyKeywords = {
    happy: 'happy',
    calm: 'chill',
    energetic: 'energetic',
    sad: 'sad',
    angry: 'angry',
    chill: 'chill',
    anxious: 'anxious',
    romantic: 'romantic',
    party: 'party',
    mellow: 'mellow',
    default: 'pop'
  };

  // Generate mosaic tiles colors for a mood
  function generateTiles(mood) {
    const sentiment = extendedSentiments[mood.toLowerCase()] || 'neutral';
    const palette = sentimentColors[sentiment];
    const tiles = [];
    for (let i = 0; i < 64; i++) {
      const base = palette[Math.floor(Math.random() * palette.length)];
      const opacity = 0.6 + Math.random() * 0.4;
      tiles.push(`${base}${Math.floor(opacity * 255).toString(16).padStart(2, '0')}`);
    }
    return tiles;
  }

  // Create mosaic element
  function createMosaic(tiles, musicTitle) {
    const mosaic = document.createElement('div');
    mosaic.classList.add('mosaic');
    tiles.forEach(color => {
      const tile = document.createElement('div');
      tile.classList.add('tile');
      tile.style.backgroundColor = color;
      mosaic.appendChild(tile);
    });
    if (musicTitle) {
      const label = document.createElement('div');
      label.classList.add('music-recommendation');
      label.textContent = musicTitle;
      mosaic.appendChild(label);
    }
    return mosaic;
  }

  // Simple NLP matcher: finds best matching mood keyword from phrase
  function findMoodKeyword(phrase) {
    phrase = phrase.toLowerCase();
    for (const mood of Object.keys(extendedSentiments)) {
      if (phrase.includes(mood)) return mood;
    }
    return 'default';
  }

  // Spotify search tracks for mood keyword
  async function searchSpotifyTracks(moodKeyword) {
    if (!isTokenValid()) {
      alert('Spotify token expired or invalid, please log in again.');
      redirectToSpotifyAuth();
      return null;
    }
    const query = `genre:${moodKeyword} OR mood:${moodKeyword} OR ${moodKeyword}`;
    const endpoint = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`;
    try {
      const response = await fetch(endpoint, {
        headers: { Authorization: 'Bearer ' + spotifyToken }
      });
      if (!response.ok) throw new Error('Spotify API error');
      const data = await response.json();
      return data.tracks.items;
    } catch (e) {
      console.error('Spotify search error:', e);
      return null;
    }
  }

  // Pick a random track from results
  function pickRandomTrack(tracks) {
    if (!tracks || tracks.length === 0) return null;
    return tracks[Math.floor(Math.random() * tracks.length)];
  }

  // Show now playing music info with embedded player
  function showNowPlaying(track) {
    if (!track) {
      document.getElementById('nowPlaying').innerHTML = '<p>No music found for this mood.</p>';
      return;
    }
    const nowPlayingDiv = document.getElementById('nowPlaying');
    nowPlayingDiv.innerHTML = `
      <h2>Now Playing: ${track.name} - ${track.artists[0].name}</h2>
      <iframe
        src="https://open.spotify.com/embed/track/${track.id}"
        width="360"
        height="80"
        frameborder="0"
        allowtransparency="true"
        allow="encrypted-media"
        allowfullscreen>
      </iframe>
    `;
  }

  // Add mosaic + music combo to gallery and UI
  async function addMoodMosaicWithSpotify(moodPhrase) {
    const mood = findMoodKeyword(moodPhrase);
    const tiles = generateTiles(mood);
    // Disable create btn while loading
    document.getElementById('createBtn').disabled = true;
    const tracks = await searchSpotifyTracks(moodToSpotifyKeywords[mood] || moodToSpotifyKeywords.default);
    document.getElementById('createBtn').disabled = false;

    let track = pickRandomTrack(tracks);
    // If no track found fallback to default genre
    if (!track && mood !== 'default') {
      const fallbackTracks = await searchSpotifyTracks(moodToSpotifyKeywords.default);
      track = pickRandomTrack(fallbackTracks);
    }

    const mosaic = createMosaic(tiles, track ? `${track.name} - ${track.artists[0].name}` : 'No song found');
    mosaic.title = `Mood: ${moodPhrase}`;
    document.getElementById('gallery').prepend(mosaic);

    showNowPlaying(track);

    // Enable save/share
    document.getElementById('saveShareBtn').disabled = false;
    // Save last combo for sharing
    window.lastCombo = { moodPhrase, tiles, track };
  }

  // Form submit handler
  document.getElementById('moodForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const input = document.getElementById('moodInput');
    const moodPhrase = input.value.trim();
    if (moodPhrase) {
      addMoodMosaicWithSpotify(moodPhrase);
      input.value = '';
      input.focus();
    }
  });

  // Save & share combo in URL hash
  function encodeComboToHash(combo) {
    const data = {
      moodPhrase: combo.moodPhrase,
      trackId: combo.track.id,
      trackName: combo.track.name,
      artistName: combo.track.artists[0].name,
      tiles: combo.tiles
    };
    return btoa(JSON.stringify(data));
  }

  function decodeComboFromHash(hash) {
    try {
      const decoded = atob(hash);
      return JSON.parse(decoded);
    } catch {
      return null;
    }
  }

  // Share button handler
  document.getElementById('saveShareBtn').addEventListener('click', () => {
    if (!window.lastCombo) return;
    const hash = encodeComboToHash(window.lastCombo);
    const shareUrl = `${window.location.origin}${window.location.pathname}#${hash}`;
    const shareLinkDiv = document.getElementById('shareLink');
    shareLinkDiv.textContent = 'Share this link: ' + shareUrl;
    navigator.clipboard.writeText(shareUrl).then(() => {
      shareLinkDiv.textContent += ' (copied to clipboard!)';
    }).catch(() => {
      // fallback no copy
    });
  });

  // On page load, check URL hash for saved combo and display it
  async function checkUrlForSharedCombo() {
    if (window.location.hash.length > 1) {
      const combo = decodeComboFromHash(window.location.hash.substring(1));
      if (combo) {
        // Rebuild mosaic from tiles array
        const mosaic = createMosaic(combo.tiles, `${combo.trackName} - ${combo.artistName}`);
        mosaic.title = `Mood: ${combo.moodPhrase}`;
        document.getElementById('gallery').prepend(mosaic);
        // Show embedded player for shared track
        document.getElementById('nowPlaying').innerHTML = `
          <h2>Now Playing: ${combo.trackName} - ${combo.artistName}</h2>
          <iframe
            src="https://open.spotify.com/embed/track/${combo.trackId}"
            width="360"
            height="80"
            frameborder="0"
            allowtransparency="true"
            allow="encrypted-media"
            allowfullscreen>
          </iframe>
        `;
        // Enable save/share button
        document.getElementById('saveShareBtn').disabled = false;
        window.lastCombo = combo;
      }
    }
  }
</script>

</body>
</html>
