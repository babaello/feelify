<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feelify – Mood Music Finder</title>
  <style>
    /* RESET & BASE */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #121212, #1db954);
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }
    a {
      color: #1db954;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }

    /* HEADER */
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    header h1 {
      font-size: 3rem;
      font-weight: 900;
      letter-spacing: 0.1em;
      margin: 0;
      color: white;
      text-shadow: 0 0 6px #1db954aa;
    }
    header p {
      font-weight: 300;
      font-size: 1.1rem;
      color: #ddd;
      margin-top: 0.3rem;
    }

    /* BUTTONS */
    button {
      cursor: pointer;
      background: #1db954;
      border: none;
      border-radius: 24px;
      padding: 0.7rem 2rem;
      font-weight: 700;
      font-size: 1rem;
      color: #121212;
      box-shadow: 0 8px 15px rgba(29, 185, 84, 0.3);
      transition: all 0.3s ease;
      margin-top: 1rem;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background: #17a74a;
      box-shadow: 0 12px 20px rgba(23, 167, 74, 0.5);
      transform: translateY(-2px);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* INPUT */
    input[type="text"] {
      width: 100%;
      max-width: 500px;
      padding: 0.75rem 1rem;
      border-radius: 24px;
      border: none;
      font-size: 1.1rem;
      margin-top: 1rem;
      outline: none;
      box-shadow: inset 0 0 8px #1db954aa;
      background-color: #222;
      color: #eee;
      transition: box-shadow 0.3s ease;
    }
    input[type="text"]:focus {
      box-shadow: inset 0 0 12px #1db954ee;
    }

    /* CONTAINERS */
    #app {
      width: 100%;
      max-width: 700px;
      background: #222;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgb(0 0 0 / 0.5);
      display: none;
      flex-direction: column;
      align-items: center;
    }

    #profile {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      width: 100%;
      color: #eee;
    }
    #profile img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid #1db954;
      box-shadow: 0 0 6px #1db954aa;
      object-fit: cover;
    }
    #profile div {
      flex-grow: 1;
    }
    #profile div strong {
      font-size: 1.3rem;
    }

    /* RESULTS */
    #results {
      width: 100%;
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 400px;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .track {
      background: #121212ee;
      padding: 1rem;
      border-radius: 12px;
      display: flex;
      gap: 1rem;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.7);
      transition: background-color 0.3s ease;
    }
    .track:hover {
      background: #1db954dd;
      color: #121212;
    }
    .track img {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      flex-shrink: 0;
      object-fit: cover;
      box-shadow: 0 0 8px #1db954bb;
    }
    .track-info {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.2rem;
    }
    .track-info strong {
      font-size: 1.1rem;
      font-weight: 700;
    }
    .track-info span {
      font-size: 0.9rem;
      color: #ccc;
    }

    /* ACTIONS */
    .track-actions {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .track-actions button {
      font-size: 0.85rem;
      padding: 0.3rem 0.8rem;
      border-radius: 16px;
      background: #1db954cc;
      color: #121212;
      box-shadow: none;
      transition: background-color 0.3s ease;
    }
    .track-actions button:hover {
      background: #17a74a;
    }

    /* AUDIO PLAYER */
    audio {
      width: 180px;
      border-radius: 8px;
      outline: none;
      box-shadow: 0 0 12px #1db954bb;
    }

    /* LOADING & MESSAGES */
    #status {
      margin-top: 1rem;
      font-style: italic;
      color: #aaa;
    }

    /* FOOTER */
    footer {
      margin-top: auto;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      padding: 1rem 0 0 0;
      user-select: none;
    }

    /* Responsive tweaks */
    @media (max-width: 600px) {
      #app {
        padding: 1rem;
      }
      audio {
        width: 100%;
      }
      .track {
        flex-direction: column;
        align-items: flex-start;
      }
      .track-actions {
        flex-direction: row;
        width: 100%;
        justify-content: flex-start;
        gap: 1rem;
        margin-top: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Feelify</h1>
    <p>Find the perfect songs for your mood, powered by Spotify</p>
  </header>

  <button id="loginBtn">Log in with Spotify</button>

  <div id="app">
    <section id="profile" aria-label="User Profile" hidden>
      <img id="userAvatar" alt="User avatar" />
      <div>
        <strong id="userName"></strong><br />
        <small id="userEmail"></small>
      </div>
    </section>

    <input
      type="text"
      id="moodInput"
      placeholder="Describe your mood or vibe (e.g. chill, happy, sad, energetic)"
      aria-label="Mood input"
      autocomplete="off"
    />
    <button id="searchBtn" disabled>Find Songs</button>

    <div id="status" aria-live="polite"></div>

    <div id="results" aria-live="polite" aria-relevant="additions"></div>
  </div>

  <footer>Feelify &copy; 2025 – Powered by Spotify API</footer>

  <script>
    // === Config ===
    const backendUrl = 'https://feelify-backend.onrender.com'; // Your backend URL here
    const redirectUri = 'https://babaello.github.io/feelify/';

    // === Elements ===
    const loginBtn = document.getElementById('loginBtn');
    const appDiv = document.getElementById('app');
    const profileSection = document.getElementById('profile');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const moodInput = document.getElementById('moodInput');
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const statusDiv = document.getElementById('status');

    // === State ===
    let accessToken = null;
    let refreshToken = null;
    let tokenExpiresAt = null;

    // --- Helpers ---
    function setStatus(message) {
      statusDiv.textContent = message;
    }

    function clearResults() {
      resultsDiv.innerHTML = '';
    }

    function formatArtists(artists) {
      return artists.map(a => a.name).join(', ');
    }

    // Get query params from URL (for code/token)
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    // --- Spotify OAuth login flow ---
    loginBtn.onclick = () => {
      window.location.href = `${backendUrl}/login`;
    };

    // --- Token exchange & setup after redirect ---
    async function exchangeCodeForToken(code) {
      try {
        setStatus('Logging you in...');
        const response = await fetch(`${backendUrl}/exchange_token?code=${encodeURIComponent(code)}`);
        const data = await response.json();

        if (data.access_token) {
          accessToken = data.access_token;
          refreshToken = data.refresh_token;
          tokenExpiresAt = Date.now() + data.expires_in * 1000;

          history.replaceState(null, '', redirectUri);

          await loadUserProfile();
          showAppUI();
          setStatus('Logged in! Enter your mood and find songs.');
          searchBtn.disabled = false;
        } else {
          setStatus('Failed to log in.');
          loginBtn.style.display = 'inline-block';
        }
      } catch {
        setStatus('Error during login.');
        loginBtn.style.display = 'inline-block';
      }
    }

    // --- Refresh token ---
    async function refreshAccessToken() {
      if (!refreshToken) return;
      try {
        const res = await fetch(`${backendUrl}/refresh_token?refresh_token=${refreshToken}`);
        const data = await res.json();
        if (data.access_token) {
          accessToken = data.access_token;
          tokenExpiresAt = Date.now() + data.expires_in * 1000;
          setStatus('Token refreshed.');
        }
      } catch (e) {
        console.warn('Failed to refresh token:', e);
      }
    }

    // --- Load Spotify User Profile ---
    async function loadUserProfile() {
      try {
        const res = await fetch('https://api.spotify.com/v1/me', {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!res.ok) throw new Error('Failed to get profile');
        const user = await res.json();

        userAvatar.src = user.images?.[0]?.url || 'https://via.placeholder.com/64?text=User';
        userName.textContent = user.display_name || 'Spotify User';
        userEmail.textContent = user.email || '';

        profileSection.hidden = false;
      } catch {
        profileSection.hidden = true;
      }
    }

    // --- Show app UI after login ---
    function showAppUI() {
      loginBtn.style.display = 'none';
      appDiv.style.display = 'flex';
    }

    // --- Search songs by mood ---
    async function searchByMood() {
      clearResults();
      setStatus('Extracting mood keywords...');
      const mood = moodInput.value.trim();
      if (!mood) {
        setStatus('Please enter a mood.');
        return;
      }

      // Refresh token if expired (simple check)
      if (tokenExpiresAt && Date.now() > tokenExpiresAt - 60000) {
        await refreshAccessToken();
      }

      try {
        // Step 1: Get mood keywords from backend
        const kwRes = await fetch(`${backendUrl}/mood_keywords?mood=${encodeURIComponent(mood)}`);
        const kwData = await kwRes.json();
        if (!kwData.keywords || kwData.keywords.length === 0) {
          setStatus('Could not extract keywords from your mood.');
          return;
        }
        const keywords = kwData.keywords.join(' ');
        setStatus(`Searching songs for mood keywords: "${keywords}"...`);

        // Step 2: Search Spotify for tracks matching those keywords
        const searchRes = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(keywords)}&type=track&limit=15`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if (!searchRes.ok) throw new Error('Spotify search failed');
        const searchData = await searchRes.json();

        const tracks = searchData.tracks?.items || [];
        if (tracks.length === 0) {
          setStatus('No songs found matching that mood.');
          return;
        }

        setStatus(`Found ${tracks.length} songs.`);

        // Step 3: Show tracks with preview and add buttons
        tracks.forEach(track => {
          const trackEl = document.createElement('div');
          trackEl.className = 'track';

          // Album art
          const img = document.createElement('img');
          img.src = track.album.images[0]?.url || '';
          img.alt = `Album art for ${track.name}`;
          trackEl.appendChild(img);

          // Info
          const infoDiv = document.createElement('div');
          infoDiv.className = 'track-info';
          const title = document.createElement('strong');
          title.textContent = track.name;
          const artists = document.createElement('span');
          artists.textContent = formatArtists(track.artists);
          infoDiv.appendChild(title);
          infoDiv.appendChild(artists);
          trackEl.appendChild(infoDiv);

          // Actions
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'track-actions';

          // Play preview if available
          if (track.preview_url) {
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = track.preview_url;
            actionsDiv.appendChild(audio);
          }

          // Open on Spotify
          const openBtn = document.createElement('button');
          openBtn.textContent = 'Open on Spotify';
          openBtn.onclick = () => window.open(track.external_urls.spotify, '_blank');
          actionsDiv.appendChild(openBtn);

          // Add to Feelify Playlist
          const addBtn = document.createElement('button');
          addBtn.textContent = 'Add to Feelify Playlist';
          addBtn.onclick = async () => {
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';
            try {
              const res = await fetch(`${backendUrl}/add_to_playlist`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${accessToken}`
                },
                body: JSON.stringify({ trackUri: track.uri })
              });
              const data = await res.json();
              if (data.success) {
                addBtn.textContent = 'Added!';
                setTimeout(() => {
                  addBtn.textContent = 'Add to Feelify Playlist';
                  addBtn.disabled = false;
                }, 2500);
              } else {
                throw new Error(data.error || 'Failed');
              }
            } catch (e) {
              addBtn.textContent = 'Error';
              setTimeout(() => {
                addBtn.textContent = 'Add to Feelify Playlist';
                addBtn.disabled = false;
              }, 2500);
              alert('Could not add track. Try again.');
            }
          };
          actionsDiv.appendChild(addBtn);

          trackEl.appendChild(actionsDiv);

          resultsDiv.appendChild(trackEl);
        });

      } catch (e) {
        setStatus('An error occurred: ' + e.message);
        console.error(e);
      }
    }

    // Enable search button only if logged in and input has text
    moodInput.addEventListener('input', () => {
      searchBtn.disabled = !moodInput.value.trim();
    });

    searchBtn.onclick = searchByMood;

    // On load, check for OAuth code in URL
    if (code) {
      loginBtn.style.display = 'none';
      exchangeCodeForToken(code);
    } else {
      // Show login if no code/token yet
      loginBtn.style.display = 'inline-block';
      appDiv.style.display = 'none';
    }
  </script>
</body>
</html>
