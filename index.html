<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feelify - Mood-Based Music Discovery</title>
  <style>
    /* CSS Variables for light/dark mode */
    :root {
      --bg-color: #121212;
      --text-color: #fff;
      --accent-color: #1DB954;
      --input-bg: #222;
      --input-text: #eee;
      --btn-bg: #1DB954;
      --btn-hover-bg: #159243;
      --link-color: #1DB954;
      --shadow-color: rgba(0, 0, 0, 0.7);
    }
    [data-theme='light'] {
      --bg-color: #fefefe;
      --text-color: #222;
      --accent-color: #1DB954;
      --input-bg: #eee;
      --input-text: #111;
      --btn-bg: #1DB954;
      --btn-hover-bg: #159243;
      --link-color: #1DB954;
      --shadow-color: rgba(0, 0, 0, 0.2);
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 650px;
      margin: 1.5rem auto;
      padding: 1rem 1.5rem 3rem;
      user-select: none;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      color: var(--accent-color);
      font-weight: 900;
      font-size: 3rem;
      text-align: center;
      margin-bottom: 0.25rem;
      user-select: text;
    }

    #loginBtn, #searchBtn, #createPlaylistBtn, #toggleThemeBtn {
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 700;
      background-color: var(--btn-bg);
      border: none;
      border-radius: 25px;
      padding: 0.65rem 1.5rem;
      color: white;
      width: 100%;
      margin: 0.8rem 0 1rem;
      box-shadow: 0 6px 12px var(--shadow-color);
      transition: background-color 0.25s ease;
      user-select: none;
      display: inline-block;
    }

    #loginBtn:hover, #searchBtn:hover, #createPlaylistBtn:hover, #toggleThemeBtn:hover {
      background-color: var(--btn-hover-bg);
    }

    input[type="text"] {
      width: 100%;
      padding: 0.8rem 1rem;
      font-size: 1.15rem;
      border-radius: 30px;
      border: none;
      background-color: var(--input-bg);
      color: var(--input-text);
      box-shadow: inset 1px 1px 5px rgba(0,0,0,0.7);
      user-select: text;
      transition: background-color 0.3s, color 0.3s;
    }

    input[type="text"]::placeholder {
      color: var(--input-text);
      opacity: 0.7;
    }

    #results {
      margin-top: 1rem;
      user-select: text;
    }

    .song-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--input-bg);
      padding: 0.6rem 1rem;
      border-radius: 16px;
      margin-bottom: 0.5rem;
      box-shadow: 0 4px 8px var(--shadow-color);
      transition: background-color 0.2s;
    }

    .song-item.voted {
      border: 2px solid var(--accent-color);
      box-shadow: 0 0 15px var(--accent-color);
    }

    .song-info {
      flex: 1;
      cursor: pointer;
      user-select: text;
    }

    .song-info:hover {
      text-decoration: underline;
    }

    .vote-btn {
      background-color: transparent;
      border: none;
      color: var(--accent-color);
      font-size: 1.3rem;
      cursor: pointer;
      user-select: none;
      transition: transform 0.15s;
      padding: 0 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vote-btn:hover {
      transform: scale(1.3);
    }

    .vote-btn.voted {
      color: #44ff66;
      text-shadow: 0 0 8px #44ff66;
    }

    .preview-player {
      margin-top: 0.25rem;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 14px var(--shadow-color);
      user-select: none;
    }

    #historyPanel {
      background: var(--input-bg);
      border-radius: 16px;
      padding: 1rem;
      margin-top: 2rem;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 6px 14px var(--shadow-color);
    }

    #historyPanel h2 {
      margin-top: 0;
      font-weight: 700;
      color: var(--accent-color);
      user-select: text;
    }

    #historyPanel button {
      margin: 0.2rem 0;
      padding: 0.4rem 0.8rem;
      background: transparent;
      border: 1.5px solid var(--accent-color);
      border-radius: 12px;
      color: var(--accent-color);
      cursor: pointer;
      font-weight: 700;
      user-select: none;
      width: 100%;
      text-align: left;
      font-size: 0.9rem;
      transition: background-color 0.3s, color 0.3s;
    }

    #historyPanel button:hover {
      background-color: var(--accent-color);
      color: var(--bg-color);
    }

    #message {
      margin-top: 1rem;
      font-style: italic;
      text-align: center;
      min-height: 1.4rem;
      user-select: text;
      color: #aaa;
    }

    #shareLinks {
      margin-top: 1rem;
      text-align: center;
    }

    #shareLinks a {
      margin: 0 0.5rem;
      color: var(--accent-color);
      font-weight: 700;
      text-decoration: none;
      user-select: none;
      font-size: 1.2rem;
      transition: color 0.3s;
    }

    #shareLinks a:hover {
      text-decoration: underline;
      color: #44ff66;
    }

    /* Responsive */
    @media (max-width: 480px) {
      body {
        margin: 1rem;
      }
      h1 {
        font-size: 2.2rem;
      }
    }
  </style>
</head>
<body data-theme="dark">

  <h1>Feelify</h1>

  <button id="toggleThemeBtn" title="Toggle Light/Dark Mode">Toggle Dark Mode</button>

  <button id="loginBtn">Log in with Spotify</button>

  <div id="app" style="display:none;">
    <input type="text" id="moodInput" placeholder="Enter your mood or vibe" autocomplete="off" />
    <button id="searchBtn">Find Songs</button>
    <button id="createPlaylistBtn" disabled>Create Playlist From Voted Songs</button>

    <div id="message"></div>
    <div id="results"></div>

    <div id="shareLinks" style="display:none;">
      <strong>Share your mood:</strong>
      <a href="#" id="shareTwitter" target="_blank" rel="noopener">üê¶ Twitter</a>
      <a href="#" id="shareFacebook" target="_blank" rel="noopener">üìò Facebook</a>
      <a href="#" id="shareLink" target="_blank" rel="noopener">üîó Copy Link</a>
    </div>

    <div id="historyPanel">
      <h2>Recent Mood Searches</h2>
      <div id="historyList"></div>
    </div>
  </div>

  <script>
    (function () {
      // Config
      const clientId = 'acb4336604304c339c55eb6db62513ca';
      const redirectUri = 'https://babaello.github.io/feelify/';
      const backendUrl = 'https://feelify-backend.onrender.com';

      // Elements
      const loginBtn = document.getElementById('loginBtn');
      const appDiv = document.getElementById('app');
      const searchBtn = document.getElementById('searchBtn');
      const moodInput = document.getElementById('moodInput');
      const resultsDiv = document.getElementById('results');
      const messageDiv = document.getElementById('message');
      const createPlaylistBtn = document.getElementById('createPlaylistBtn');
      const toggleThemeBtn = document.getElementById('toggleThemeBtn');
      const historyList = document.getElementById('historyList');
      const shareLinks = document.getElementById('shareLinks');
      const shareTwitter = document.getElementById('shareTwitter');
      const shareFacebook = document.getElementById('shareFacebook');
      const shareLink = document.getElementById('shareLink');

      let accessToken = null;
      let currentMood = '';
      let songsData = [];
      let votes = {}; // songURI -> vote count

      // --- Theme handling ---
      function setTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        toggleThemeBtn.textContent = theme === 'dark' ? 'Toggle Light Mode' : 'Toggle Dark Mode';
      }

      toggleThemeBtn.onclick = () => {
        const current = document.body.getAttribute('data-theme');
        setTheme(current === 'dark' ? 'light' : 'dark');
      };

      // Load theme from localStorage
      const savedTheme = localStorage.getItem('theme') || 'dark';
      setTheme(savedTheme);

      // --- OAuth Login ---

      // Scopes including playlist creation
      const scopes = [
        'user-read-private',
        'user-read-email',
        'playlist-modify-public',
        'playlist-modify-private',
      ].join(' ');

      function getCodeFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('code');
      }

      async function exchangeCodeForToken(code) {
        try {
          const res = await fetch(`${backendUrl}/exchange_token?code=${code}`);
          if (!res.ok) throw new Error('Failed token exchange');
          const data = await res.json();
          if (data.access_token) {
            accessToken = data.access_token;
            return true;
          }
          throw new Error('No access token received');
        } catch (e) {
          showMessage('Login failed, please try again.');
          console.error(e);
          return false;
        }
      }

      function showMessage(text, isError = false) {
        messageDiv.textContent = text;
        messageDiv.style.color = isError ? 'tomato' : 'lightgreen';
      }

      // --- Search with NLP Synonyms using Datamuse API ---
      async function getSynonyms(word) {
        try {
          const res = await fetch(`https://api.datamuse.com/words?ml=${encodeURIComponent(word)}`);
          if (!res.ok) return [];
          const data = await res.json();
          // Return max 5 synonyms, filter out phrases
          return data.filter(w => !w.word.includes(' ')).slice(0, 5).map(w => w.word);
        } catch {
          return [];
        }
      }

      // Build query string with synonyms
      async function buildSearchQuery(mood) {
        const synonyms = await getSynonyms(mood);
        const queryWords = [mood, ...synonyms];
        // Also add mood words lowercased and with some fuzziness
        return queryWords.map(w => `${w}`).join(' ');
      }

      // --- Search Tracks ---
      async function searchTracks(mood) {
        if (!accessToken) {
          alert('Please log in first.');
          return;
        }
        showMessage('Searching songs for mood: ' + mood);
        resultsDiv.innerHTML = '';
        createPlaylistBtn.disabled = true;

        const query = await buildSearchQuery(mood);
        try {
          const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=20`, {
            headers: { Authorization: 'Bearer ' + accessToken }
          });
          if (!res.ok) {
            if (res.status === 401) {
              showMessage('Session expired. Please log in again.', true);
              logout();
              return;
            }
            throw new Error('Spotify API error');
          }
          const data = await res.json();
          songsData = data.tracks.items || [];

          if (songsData.length === 0) {
            showMessage('No songs found for that mood.', true);
            return;
          }

          // Reset votes for new songs
          votes = {};

          displaySongs(songsData);
          createPlaylistBtn.disabled = true;

          showMessage('Found ' + songsData.length + ' songs for mood: ' + mood);

          // Save mood history
          saveMoodSearch(mood);
          renderMoodHistory();

          // Show share buttons
          setupShareLinks(mood);
          shareLinks.style.display = 'block';
        } catch (err) {
          showMessage('Error fetching songs.', true);
          console.error(err);
        }
      }

      // --- Display Songs with voting and preview ---
      function displaySongs(tracks) {
        resultsDiv.innerHTML = '';

        tracks.forEach(track => {
          const songDiv = document.createElement('div');
          songDiv.className = 'song-item';
          songDiv.dataset.uri = track.uri;
          songDiv.dataset.voted = 'false';

          // Song info: name ‚Äî artists
          const infoDiv = document.createElement('div');
          infoDiv.className = 'song-info';
          infoDiv.textContent = `${track.name} ‚Äî ${track.artists.map(a => a.name).join(', ')}`;
          infoDiv.title = 'Click to open in Spotify';
          infoDiv.onclick = () => window.open(track.external_urls.spotify, '_blank');

          // Vote button
          const voteBtn = document.createElement('button');
          voteBtn.className = 'vote-btn';
          voteBtn.innerHTML = 'üëç';
          voteBtn.title = 'Vote for this song';

          voteBtn.onclick = () => {
            const voted = songDiv.dataset.voted === 'true';
            if (!voted) {
              votes[track.uri] = (votes[track.uri] || 0) + 1;
              songDiv.dataset.voted = 'true';
              voteBtn.classList.add('voted');
              songDiv.classList.add('voted');
              createPlaylistBtn.disabled = false;
            } else {
              votes[track.uri] = Math.max((votes[track.uri] || 1) - 1, 0);
              if (votes[track.uri] === 0) {
                delete votes[track.uri];
                songDiv.dataset.voted = 'false';
                voteBtn.classList.remove('voted');
                songDiv.classList.remove('voted');
              }
              // Disable playlist button if no votes
              createPlaylistBtn.disabled = Object.keys(votes).length === 0;
            }
            sortSongsByVotes();
          };

          // Preview audio player (30s preview)
          const previewUrl = track.preview_url;
          let playerIframe = null;
          if (previewUrl) {
            playerIframe = document.createElement('audio');
            playerIframe.className = 'preview-player';
            playerIframe.controls = true;
            playerIframe.src = previewUrl;
          }

          songDiv.appendChild(infoDiv);
          songDiv.appendChild(voteBtn);
          if (playerIframe) songDiv.appendChild(playerIframe);

          resultsDiv.appendChild(songDiv);
        });
      }

      // --- Sort songs by votes ---
      function sortSongsByVotes() {
        const items = Array.from(resultsDiv.children);
        items.sort((a, b) => {
          const aVotes = votes[a.dataset.uri] || 0;
          const bVotes = votes[b.dataset.uri] || 0;
          return bVotes - aVotes;
        });
        items.forEach(item => resultsDiv.appendChild(item));
      }

      // --- Create Playlist from voted songs ---
      async function createPlaylist() {
        if (!accessToken) {
          alert('Please log in first.');
          return;
        }

        const votedUris = Object.keys(votes);
        if (votedUris.length === 0) {
          alert('Vote for some songs first!');
          return;
        }

        createPlaylistBtn.disabled = true;
        showMessage('Creating playlist...');

        try {
          // Get current user ID
          const userRes = await fetch('https://api.spotify.com/v1/me', {
            headers: { Authorization: 'Bearer ' + accessToken }
          });
          if (!userRes.ok) throw new Error('Failed to fetch user info');
          const userData = await userRes.json();

          // Create new playlist
          const playlistName = `Feelify Mood Playlist: ${currentMood}`;
          const createRes = await fetch(`https://api.spotify.com/v1/users/${userData.id}/playlists`, {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + accessToken,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: playlistName,
              description: `Generated with Feelify for mood: ${currentMood}`,
              public: false,
            }),
          });
          if (!createRes.ok) throw new Error('Failed to create playlist');
          const playlistData = await createRes.json();

          // Add tracks
          const addRes = await fetch(`https://api.spotify.com/v1/playlists/${playlistData.id}/tracks`, {
            method: 'POST',
            headers: {
              Authorization: 'Bearer ' + accessToken,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ uris: votedUris }),
          });
          if (!addRes.ok) throw new Error('Failed to add tracks');

          showMessage(`Playlist created! View it on Spotify.`);
          createPlaylistBtn.disabled = false;

          // Open playlist on Spotify
          window.open(playlistData.external_urls.spotify, '_blank');
        } catch (err) {
          showMessage('Error creating playlist.', true);
          createPlaylistBtn.disabled = false;
          console.error(err);
        }
      }

      // --- Save and Load Mood Search History ---
      function saveMoodSearch(mood) {
        if (!mood) return;
        let history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        if (!history.includes(mood.toLowerCase())) {
          history.unshift(mood.toLowerCase());
          if (history.length > 10) history.pop();
          localStorage.setItem('moodHistory', JSON.stringify(history));
        }
      }

      function renderMoodHistory() {
        const history = JSON.parse(localStorage.getItem('moodHistory') || '[]');
        historyList.innerHTML = '';
        if (history.length === 0) {
          historyList.textContent = 'No previous moods searched.';
          return;
        }
        history.forEach(m => {
          const btn = document.createElement('button');
          btn.textContent = m;
          btn.onclick = () => {
            moodInput.value = m;
            doSearch();
          };
          historyList.appendChild(btn);
        });
      }

      // --- Share Links ---
      function setupShareLinks(mood) {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(`I'm feeling "${mood}" and found awesome music with Feelify! üéµ`);

        shareTwitter.href = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
        shareFacebook.href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        shareLink.onclick = (e) => {
          e.preventDefault();
          navigator.clipboard.writeText(window.location.href).then(() => {
            alert('Link copied to clipboard!');
          });
        };
      }

      // --- Logout (Clear tokens & UI) ---
      function logout() {
        accessToken = null;
        loginBtn.style.display = 'inline-block';
        appDiv.style.display = 'none';
        resultsDiv.innerHTML = '';
        messageDiv.textContent = '';
        createPlaylistBtn.disabled = true;
        shareLinks.style.display = 'none';
        window.history.replaceState({}, document.title, '/'); // clear code from URL
      }

      // --- Main Search Action ---
      async function doSearch() {
        const mood = moodInput.value.trim();
        if (!mood) {
          showMessage('Please enter a mood or vibe to search.', true);
          return;
        }
        currentMood = mood;
        await searchTracks(mood);
      }

      // --- Initialize App ---
      async function init() {
        // Check URL for Spotify auth code
        const code = getCodeFromUrl();
        if (code) {
          loginBtn.disabled = true;
          const success = await exchangeCodeForToken(code);
          if (success) {
            loginBtn.style.display = 'none';
            appDiv.style.display = 'block';
            showMessage('Logged in successfully! Enter your mood and find songs.');
            renderMoodHistory();
            loginBtn.disabled = false;
            window.history.replaceState({}, document.title, '/'); // clean URL
          } else {
            loginBtn.disabled = false;
          }
        } else {
          loginBtn.style.display = 'inline-block';
          appDiv.style.display = 'none';
        }
      }

      loginBtn.onclick = () => {
        const authUrl = new URL('https://accounts.spotify.com/authorize');
        authUrl.searchParams.set('client_id', clientId);
        authUrl.searchParams.set('response_type', 'code');
        authUrl.searchParams.set('redirect_uri', redirectUri);
        authUrl.searchParams.set('scope', scopes);
        authUrl.searchParams.set('show_dialog', 'true');
        window.location.href = authUrl.toString();
      };

      searchBtn.onclick = doSearch;
      createPlaylistBtn.onclick = createPlaylist;

      moodInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') doSearch();
      });

      // On load
      init();
    })();
  </script>
</body>
</html>
